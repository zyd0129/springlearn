## 微服务架构

微服务，单独进程，独立部署，可以单独数据库，可以不同语言开发，足够内聚，小团队开发。

微服务框架，是把微服务整合起来，提高完整的服务；

![这里写图片描述](/Users/yudong/learn/alibaba/java/imgs/701.png)

服务注册与发现 服务调用 服务荣孤单 服务降级 

负载均衡 服务网关 配置中心 服务监控 全链路追踪

消息队列 自动化构建部署 服务定时任务调度操作

服务注册中心：**eureka**,**zookeeper**,consul(go),**nacos**

服务负责均衡：ribbon,loadBalancer

服务调用： feign(X) openFeign

服务降级： Hystrix(X) resilience4j sentinel

服务网关：zuul **gateway**

服务配置： config(X)  apolo（携程)  **nacos**

服务总线： bus **nacos**



**单体架构 和 微服务架构**

单体架构，所有模块打包成一个jar包，共享一个Jvm；一个模块挂了，程序就挂了

链路追踪，为了追查bug 在哪个服务发生；

服务雪崩，有了熔断降级处理

服务治理，管理服务的注册、续约、剔除等。

微服务架构，整个系统有若干独立的微服务构成，服务之间通过远程调用。

## CAP理论

![img](https://www.wangbase.com/blogimg/asset/201807/bg2018071607.jpg)

分区容错：因为网络存在抖动，区间通信可能失败；因此分区容错一定成立，除非单台机子；就不是分布式了。

![img](https://www.wangbase.com/blogimg/asset/201807/bg2018071601.png)

一致性：

写入G1，v1；那么从同一时间从G2读到的也是v1；

可用性：

Availability 中文叫做"可用性"，意思是只要收到用户的请求，服务器就必须给出回应。

### Consistency 和 Availability 的矛盾

一致性和可用性，为什么不可能同时成立？答案很简单，因为可能通信失败（即出现分区容错）。

如果保证 G2 的一致性，那么 G1 必须在写操作时，锁定 G2 的读操作和写操作。只有数据同步后，才能重新开放读写。锁定期间，G2 不能读写，没有可用性不。

如果保证 G2 的可用性，那么势必不能锁定 G2，所以一致性不成立。

综上所述，G2 无法同时做到一致性和可用性。系统设计时只能选择一个目标。如果追求一致性，那么无法保证所有节点的可用性；如果追求所有节点的可用性，那就没法做到一致性。

## 服务注册/服务治理

Eureka 采用cs的设计架构，存在一个Eureka Server,即注册中心；其它服务是客户端，连接到server并维持心跳。

客户端从server获取其它服务信息，然后直接发起调用

Eureka是AP理论， 有保护机制，节点删除之后，不会把它的注册信息立马删除掉

默认情况下，如果EurekaServer再一定时间内没有接受到某个微服务实例的心跳，server将会注销该实例（默认90s）；但是当网络分区故障发生（延迟、卡顿、拥挤）时，微服务和EurekaServer之间无法正常通行，以上行为可能变得非常危险--因为微服务本身其实时健康的，此时本不应该注销这个微服务。Eureka通过“自我保护模式" 来解决这个问题。当EurekaServer节点再短时间内丢失过多客户端时，（可能发生了网络分区故障），那么这个节点就会进入自我保护模式，宁可放过一千，不可错杀一个。

```yml
enable-self-preservation: false  //关闭自我保护
```

```
lease-renewal-interval-in-seconds: 1 //客户端设置心跳间隔
lease-expiration-duration-in-seconds: 2 //收到心跳2s后没有收到心跳，即剔除
```

#### 为什么需要注册中心？为什么不用nginx

硬编码的问题

![image-20200727232358345](/Users/yudong/learn/alibaba/java/imgs/image-20200727232358345.png)

1.硬编码调用rest，或者手动维护一个注册表（这个相当于Nginx了）

2.如果做服务集群，扩容的时候都需要手动修改；无法**动态感知**，人工干预效率低

#### 注册中心功能

提供注册接口、服务获取接口、心跳检测接口、取消注册接口

1.动态感知，服务A挂掉了，要剔除 服务器端起一个 服务端要起一个定时任务

2.如果注册中心挂了呢？客户端缓存一份列表 客户端与注册中心数据同步问题？客户端也要有一个定时任务，每隔30s拉取一次

总结一下：

服务端：

- 服务注册
- 服务发现接口
- 心跳检测
- 定时任务，清除不可用服务

客户端：

- 缓存服务列表
- 定时任务，重新拉取服务列表
- 注册
- 心跳

#### Eureka 集群架构

![image-20200727234358954](/Users/yudong/learn/alibaba/java/imgs/image-20200727234358954.png)

每个EurekaServer可以在不同的地区，实现高可用。可以选两个地区，避免断电。